edition = "2023";

package zyphor.v1;

import "buf/validate/validate.proto";
import "google/api/annotations.proto";
import "google/protobuf/duration.proto";
import "google/protobuf/timestamp.proto";
import "zyphor/v1/options.proto";
import "zyphor/v1/principal.proto";

service TargetService {
  rpc GetTarget(GetTargetRequest) returns (GetTargetResponse) {
    option idempotency_level = NO_SIDE_EFFECTS;
    option (google.api.http) = {get: "/v1/target/{id}"};
  }
  rpc CreateTarget(CreateTargetRequest) returns (CreateTargetResponse) {
    option (google.api.http) = {
      post: "/v1/target"
      body: "*"
    };
  }
  rpc UpdateTarget(UpdateTargetRequest) returns (UpdateTargetResponse) {
    option (google.api.http) = {
      patch: "/v1/target/{id}"
      body: "*"
    };
  }
  rpc DeleteTarget(DeleteTargetRequest) returns (DeleteTargetResponse) {
    option (google.api.http) = {delete: "/v1/target/{id}"};
  }
  rpc ListTargets(ListTargetsRequest) returns (ListTargetsResponse) {
    option idempotency_level = NO_SIDE_EFFECTS;
    option (google.api.http) = {get: "/v1/targets/{workspace_id}"};
  }
  rpc AddTargetEndpoint(AddTargetEndpointRequest) returns (AddTargetEndpointResponse) {
    option (google.api.http) = {post: "/v1/target/{target_id}/endpoint/{value}"};
  }
  rpc RemoveTargetEndpoint(RemoveTargetEndpointRequest) returns (RemoveTargetEndpointResponse) {
    option (google.api.http) = {delete: "/v1/target/{target_id}/endpoint/{value}"};
  }
  rpc GetSubjectAccess(GetSubjectAccessRequest) returns (GetSubjectAccessResponse) {
    option (google.api.http) = {
      get: "/v1/target/access"
      body: "*"
    };
  }
}

message Target {
  string id = 1;
  string workspace_id = 2;
  string template_id = 3;
  string name = 4;
  string description = 5;
  repeated string endpoints = 6 [(zyphor.v1.sensitive) = true];
  repeated Principal principals = 7;
  TargetMetadata metadata = 8;
  google.protobuf.Timestamp created_at = 9;
  google.protobuf.Timestamp updated_at = 10;
}
message TargetMetadata {
  // Basic system info
  string hostname = 1;
  string host_id = 2;
  string os = 3;
  string platform = 4;
  string platform_version = 5;
  string architecture = 6;

  // Networking
  repeated string ip_addresses = 7 [(zyphor.v1.sensitive) = true];

  // SSH-specific metadata
  string ssh_version = 8;
  bool ssh_service_running = 9;
  repeated string ssh_ports = 10;

  // Extras
  repeated string tags = 11;
}

message GetTargetRequest {
  string id = 1 [(buf.validate.field).string.uuid = true];
  string workspace_id = 2 [(buf.validate.field).string.uuid = true];
}
message GetTargetResponse {
  Target target = 1;
}

message CreateTargetRequest {
  string workspace_id = 1 [(buf.validate.field).string.uuid = true];
  string name = 2 [(buf.validate.field).string = {
    min_len: 1
    max_len: 255
    pattern: "^[a-zA-Z0-9][a-zA-Z0-9-_]*$"
  }];
  string description = 3 [(buf.validate.field).string.max_len = 1000];
  string template_id = 4 [(buf.validate.field).string.uuid = true];
  TargetMetadata metadata = 5;
}
message CreateTargetResponse {
  Target target = 1;
}

message UpdateTargetRequest {
  string id = 1 [(buf.validate.field).string.uuid = true];
  string workspace_id = 2 [(buf.validate.field).string.uuid = true];
  string template_id = 3 [(buf.validate.field).string.uuid = true];
  string name = 4 [(buf.validate.field).string = {
    min_len: 1
    max_len: 255
    pattern: "^[a-zA-Z0-9][a-zA-Z0-9-_]*$"
  }];
  string description = 5 [(buf.validate.field).string.max_len = 1000];
  TargetMetadata metadata = 6;
}
message UpdateTargetResponse {
  Target target = 1;
}

message DeleteTargetRequest {
  string id = 1 [(buf.validate.field).string.uuid = true];
  string workspace_id = 2 [(buf.validate.field).string.uuid = true];
}
message DeleteTargetResponse {}

message ListTargetsRequest {
  string workspace_id = 1 [(buf.validate.field).string.uuid = true];
}
message ListTargetsResponse {
  repeated Target targets = 1;
}

message AddTargetEndpointRequest {
  string target_id = 1 [(buf.validate.field).string.uuid = true];
  string workspace_id = 2 [(buf.validate.field).string.uuid = true];
  string value = 3 [
    (buf.validate.field).cel = {
      id: "value.ip_or_uri"
      message: "value must be either a valid IP or a valid URI"
      expression: "this.isIp() || this.isUri()"
    },
    (zyphor.v1.sensitive) = true
  ];
}
message AddTargetEndpointResponse {}

message RemoveTargetEndpointRequest {
  string target_id = 1 [(buf.validate.field).string.uuid = true];
  string workspace_id = 2 [(buf.validate.field).string.uuid = true];
  string value = 3 [
    (buf.validate.field).cel = {
      id: "value.ip_or_uri"
      message: "value must be either a valid IP or a valid URI"
      expression: "this.isIp() || this.isUri()"
    },
    (zyphor.v1.sensitive) = true
  ];
}
message RemoveTargetEndpointResponse {}

message AccessibleTarget {
  string target_id = 1;
  string target_name = 2;
  string target_description = 3;
  repeated string endpoints = 4 [(zyphor.v1.sensitive) = true];
  repeated string usernames = 5 [(zyphor.v1.sensitive) = true];
  string ca_id = 6;
  string ca_name = 7;
  string template_id = 8;
  google.protobuf.Duration default_ttl = 9;
  google.protobuf.Duration max_ttl = 10;
}

message GetSubjectAccessRequest {
  string workspace_id = 1 [(buf.validate.field).string.uuid = true];
  string subject_id = 2 [(buf.validate.field).string.uuid = true];
  PrincipalType type = 3 [(buf.validate.field).enum = {
    defined_only: true
    not_in: [0]
  }];
}
message GetSubjectAccessResponse {
  repeated AccessibleTarget targets = 1;
}
