edition = "2023";

package zyphor.v1;

import "buf/validate/validate.proto";
import "google/api/annotations.proto";
import "google/protobuf/duration.proto";
import "google/protobuf/struct.proto";
import "google/protobuf/timestamp.proto";
import "zyphor/v1/options.proto";

service CertificateService {
  // Certificate Authority messages -------------------------------------------
  rpc GetCertificateAuthority(GetCertificateAuthorityRequest) returns (GetCertificateAuthorityResponse) {
    option idempotency_level = NO_SIDE_EFFECTS;
    option (google.api.http) = {get: "/v1/certificate_authority/{id}"};
  }
  rpc CreateCertificateAuthority(CreateCertificateAuthorityRequest) returns (CreateCertificateAuthorityResponse) {
    option (google.api.http) = {
      post: "/v1/certificate_authority"
      body: "*"
    };
  }
  rpc UpdateCertificateAuthority(UpdateCertificateAuthorityRequest) returns (UpdateCertificateAuthorityResponse) {
    option (google.api.http) = {
      patch: "/v1/certificate_authority/{id}"
      body: "*"
    };
  }
  rpc ListCertificateAuthorities(ListCertificateAuthoritiesRequest) returns (ListCertificateAuthoritiesResponse) {
    option idempotency_level = NO_SIDE_EFFECTS;
    option (google.api.http) = {get: "/v1/certificate_authorities/{workspace_id}"};
  }
  rpc DeleteCertificateAuthority(DeleteCertificateAuthorityRequest) returns (DeleteCertificateAuthorityResponse) {
    option (google.api.http) = {delete: "/v1/certificate_authority/{id}"};
  }
  rpc RolloverCertificateAuthority(RolloverCertificateAuthorityRequest) returns (RolloverCertificateAuthorityResponse) {
    option (google.api.http) = {post: "/v1/certificate_authority/{id}/rollover"};
  }

  // Certificate Template messages --------------------------------------------
  rpc GetCertificateTemplate(GetCertificateTemplateRequest) returns (GetCertificateTemplateResponse) {
    option idempotency_level = NO_SIDE_EFFECTS;
    option (google.api.http) = {get: "/v1/certificate_template/{id}"};
  }
  rpc CreateCertificateTemplate(CreateCertificateTemplateRequest) returns (CreateCertificateTemplateResponse) {
    option (google.api.http) = {
      post: "/v1/certificate_template"
      body: "*"
    };
  }
  rpc UpdateCertificateTemplate(UpdateCertificateTemplateRequest) returns (UpdateCertificateTemplateResponse) {
    option (google.api.http) = {
      patch: "/v1/certificate_template/{id}"
      body: "*"
    };
  }
  rpc ListCertificateTemplates(ListCertificateTemplatesRequest) returns (ListCertificateTemplatesResponse) {
    option idempotency_level = NO_SIDE_EFFECTS;
    option (google.api.http) = {get: "/v1/certificate_templates/{workspace_id}"};
  }
  rpc DeleteCertificateTemplate(DeleteCertificateTemplateRequest) returns (DeleteCertificateTemplateResponse) {
    option (google.api.http) = {delete: "/v1/certificate_template/{id}"};
  }

  // Issue certificates
  rpc SignPublicKey(SignPublicKeyRequest) returns (SignPublicKeyResponse) {
    option (google.api.http) = {
      post: "/v1/sign"
      body: "*"
    };
  }
}

enum CertificateKeyType {
  CERTIFICATE_KEY_TYPE_UNSPECIFIED = 0;
  CERTIFICATE_KEY_TYPE_RSA = 1;
  CERTIFICATE_KEY_TYPE_ECDSA = 2;
  CERTIFICATE_KEY_TYPE_ED25519 = 3;
}
enum CertificateType {
  CERTIFICATE_TYPE_UNSPECIFIED = 0;
  CERTIFICATE_TYPE_USER = 1;
  CERTIFICATE_TYPE_HOST = 2;
}

// Certificate Authority messages ---------------------------------------------
message CertificateAuthority {
  string id = 1;
  string workspace_id = 2;
  string name = 3;
  string description = 4;
  string certificate = 5;
  string public_key = 6;
  string serial_number = 7;
  string subject = 8;
  google.protobuf.Timestamp not_before = 9;
  google.protobuf.Timestamp not_after = 10;
  bool is_active = 11;
  bool is_default = 12;
  CertificateKeyType key_type = 13;
  int32 key_bits = 14;
  google.protobuf.Timestamp created_at = 15;
  google.protobuf.Timestamp updated_at = 16;
}

message CreateCertificateAuthorityRequest {
  string workspace_id = 1 [(buf.validate.field).string.uuid = true];
  string name = 2 [(buf.validate.field).string = {
    min_len: 1
    max_len: 255
  }];
  string description = 3 [(buf.validate.field).string.max_len = 1000];
  CertificateKeyType key_type = 4 [(buf.validate.field).enum = {
    defined_only: true
    not_in: [0]
  }];
  int32 key_bits = 5;
  int32 lifetime_months = 6 [(buf.validate.field).int32 = {
    gte: 1
    lte: 60 // Max 5 years
  }];
  bool is_default = 7;
}
message CreateCertificateAuthorityResponse {
  CertificateAuthority certificate_authority = 1;
}

message GetCertificateAuthorityRequest {
  string id = 1 [(buf.validate.field).string.uuid = true];
}
message GetCertificateAuthorityResponse {
  CertificateAuthority certificate_authority = 1;
}

message ListCertificateAuthoritiesRequest {
  string workspace_id = 1 [(buf.validate.field).string.uuid = true];
}
message ListCertificateAuthoritiesResponse {
  repeated CertificateAuthority cas = 1;
}

message UpdateCertificateAuthorityRequest {
  string id = 1 [(buf.validate.field).string.uuid = true];
  string description = 2 [(buf.validate.field).string.max_len = 1000];
  bool is_active = 3;
  bool is_default = 4;
}
message UpdateCertificateAuthorityResponse {
  CertificateAuthority certificate_authority = 1;
}

message DeleteCertificateAuthorityRequest {
  string id = 1 [(buf.validate.field).string.uuid = true];
}
message DeleteCertificateAuthorityResponse {}

message RolloverCertificateAuthorityRequest {
  string id = 1 [(buf.validate.field).string.uuid = true];
  CertificateKeyType key_type = 2;
  int32 key_bits = 3;
  int32 lifetime_months = 4;
  bool force = 5;
}
message RolloverCertificateAuthorityResponse {
  CertificateAuthority certificate_authority = 1;
}

// Certificate Template messages ----------------------------------------------
message CertificateTemplate {
  string id = 1;
  string ca_id = 2;
  string name = 3;
  string description = 4;
  CertificateType type = 5;
  google.protobuf.Duration default_ttl = 6;
  google.protobuf.Duration max_ttl = 7;
  map<string, string> extensions = 8;
  map<string, string> critical_options = 9;
  repeated CertificateKeyType allowed_key_types = 10;
  bool is_active = 11;
  google.protobuf.Timestamp created_at = 12;
  google.protobuf.Timestamp updated_at = 13;
}

message CreateCertificateTemplateRequest {
  string ca_id = 1 [(buf.validate.field).string.uuid = true];
  string name = 2 [(buf.validate.field).string.min_len = 1];
  string workspace_id = 3 [(buf.validate.field).string.uuid = true];
  string description = 4 [(buf.validate.field).string.max_len = 1000];
  CertificateType type = 5 [(buf.validate.field).enum = {
    defined_only: true
    not_in: [0]
  }];
  google.protobuf.Duration default_ttl = 6 [(buf.validate.field).duration = {
    gte: {seconds: 60} /* Min 1 minute */
    lte: {seconds: 31536000} /* Max 1 year */
  }];
  google.protobuf.Duration max_ttl = 7 [(buf.validate.field).duration = {
    gte: {seconds: 60}
    lte: {seconds: 31536000}
  }];
  map<string, string> extensions = 8;
  map<string, string> critical_options = 9;
  repeated CertificateKeyType allowed_key_types = 10;
  google.protobuf.Struct custom_extensions = 11;
}
message CreateCertificateTemplateResponse {
  CertificateTemplate certificate_template = 1;
}

message GetCertificateTemplateRequest {
  string id = 1 [(buf.validate.field).string.uuid = true];
}
message GetCertificateTemplateResponse {
  CertificateTemplate certificate_template = 1;
}

message ListCertificateTemplatesRequest {
  string workspace_id = 1 [(buf.validate.field).string.uuid = true];
}
message ListCertificateTemplatesResponse {
  repeated CertificateTemplate templates = 1;
}

message UpdateCertificateTemplateRequest {
  string id = 1 [(buf.validate.field).string.uuid = true];
  string ca_id = 2 [(buf.validate.field).string.uuid = true];
  string description = 3 [(buf.validate.field).string.max_len = 1000];
  CertificateType type = 4 [(buf.validate.field).enum = {
    defined_only: true
    not_in: [0]
  }];
  google.protobuf.Duration default_ttl = 5;
  google.protobuf.Duration max_ttl = 6;
  map<string, string> extensions = 7;
  map<string, string> critical_options = 8;
  bool is_active = 9;
  repeated CertificateKeyType allowed_key_types = 10;
}
message UpdateCertificateTemplateResponse {
  CertificateTemplate certificate_template = 1;
}

message DeleteCertificateTemplateRequest {
  string id = 1 [(buf.validate.field).string.uuid = true];
}
message DeleteCertificateTemplateResponse {}

// Certificate messages -------------------------------------------------------
message Certificate {
  string ca_id = 1;
  string ca_name = 2;
  bytes ssh_certificate = 3 [(zyphor.v1.sensitive) = true];
  bytes ca_public_key = 4 [(zyphor.v1.sensitive) = true];
  google.protobuf.Timestamp expires_at = 5;
}
message SSHConfigOptions {
  string key_name = 1 [(buf.validate.field).string = {
    pattern: "^[a-zA-Z0-9_-]+$"
    max_len: 100
  }];
  string strict_host_key_checking = 2 [
    (buf.validate.field).string.in = "yes",
    (buf.validate.field).string.in = "no",
    (buf.validate.field).string.in = "accept-new"
  ];
  int32 keep_alive_interval = 3 [(buf.validate.field).int32 = {
    gte: 0
    lte: 3600
  }];
  int32 connect_timeout = 4 [(buf.validate.field).int32 = {
    gte: 1
    lte: 300
  }];
  bool add_hash_known_hosts = 5; // add HashKnownHosts yes
  string user_known_hosts_file = 6; // custom known_hosts file
  bool compression = 7; // enable compression
}

message SignPublicKeyRequest {
  string workspace_id = 1 [(buf.validate.field).string.uuid = true];
  repeated string public_keys = 2 [
    (buf.validate.field).repeated.items.string = {
      min_len: 1
      max_len: 10000
      pattern: "^[a-z0-9][a-z0-9.-]*[a-z0-9][ \t]+[A-Za-z0-9+/]+=*[ \t]*.*$"
    },
    (zyphor.v1.sensitive) = true
  ];
  CertificateType type = 3 [(buf.validate.field).enum = {
    defined_only: true
    not_in: [0]
  }];
  google.protobuf.Duration ttl = 4 [(buf.validate.field).duration = {
    gte: {seconds: 60}
    lte: {seconds: 31536000}
  }];
  SSHConfigOptions options = 5;
}
message SignPublicKeyResponse {
  repeated Certificate certificates = 1;
}
