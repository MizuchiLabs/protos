edition = "2023";

package zyphor.v1;

import "buf/validate/validate.proto";
import "google/api/annotations.proto";
import "google/protobuf/duration.proto";
import "google/protobuf/struct.proto";
import "google/protobuf/timestamp.proto";
import "zyphor/v1/options.proto";

service CertificateService {
  // Certificate Authority messages -------------------------------------------
  rpc GetCA(GetCARequest) returns (GetCAResponse) {
    option idempotency_level = NO_SIDE_EFFECTS;
    option (google.api.http) = {get: "/v1/ca/{id}"};
  }
  rpc CreateCA(CreateCARequest) returns (CreateCAResponse) {
    option (google.api.http) = {
      post: "/v1/ca"
      body: "*"
    };
  }
  rpc UpdateCA(UpdateCARequest) returns (UpdateCAResponse) {
    option (google.api.http) = {
      patch: "/v1/ca/{id}"
      body: "*"
    };
  }
  rpc ListCAs(ListCAsRequest) returns (ListCAsResponse) {
    option idempotency_level = NO_SIDE_EFFECTS;
    option (google.api.http) = {get: "/v1/cas/{workspace_id}"};
  }
  rpc DeleteCA(DeleteCARequest) returns (DeleteCAResponse) {
    option (google.api.http) = {delete: "/v1/ca/{id}"};
  }
  rpc RolloverCA(RolloverCARequest) returns (RolloverCAResponse) {
    option (google.api.http) = {post: "/v1/ca/{id}/rollover"};
  }

  // Certificate Template messages --------------------------------------------
  rpc GetCertTemplate(GetCertTemplateRequest) returns (GetCertTemplateResponse) {
    option idempotency_level = NO_SIDE_EFFECTS;
    option (google.api.http) = {get: "/v1/template/{id}"};
  }
  rpc CreateCertTemplate(CreateCertTemplateRequest) returns (CreateCertTemplateResponse) {
    option (google.api.http) = {
      post: "/v1/template"
      body: "*"
    };
  }
  rpc UpdateCertTemplate(UpdateCertTemplateRequest) returns (UpdateCertTemplateResponse) {
    option (google.api.http) = {
      patch: "/v1/template/{id}"
      body: "*"
    };
  }
  rpc ListCertTemplates(ListCertTemplatesRequest) returns (ListCertTemplatesResponse) {
    option idempotency_level = NO_SIDE_EFFECTS;
    option (google.api.http) = {get: "/v1/templates/{workspace_id}"};
  }
  rpc DeleteCertTemplate(DeleteCertTemplateRequest) returns (DeleteCertTemplateResponse) {
    option (google.api.http) = {delete: "/v1/template/{id}"};
  }

  // Issue certificates
  rpc SignPublicKeyUser(SignPublicKeyUserRequest) returns (SignPublicKeyUserResponse) {
    option (google.api.http) = {
      post: "/v1/user/sign"
      body: "*"
    };
  }
  rpc SignPublicKeyHost(SignPublicKeyHostRequest) returns (SignPublicKeyHostResponse) {
    option (google.api.http) = {
      post: "/v1/host/sign"
      body: "*"
    };
  }
}

enum CertificateKeyType {
  CERTIFICATE_KEY_TYPE_UNSPECIFIED = 0;
  CERTIFICATE_KEY_TYPE_RSA = 1;
  CERTIFICATE_KEY_TYPE_ECDSA = 2;
  CERTIFICATE_KEY_TYPE_ED25519 = 3;
}
enum CertificateType {
  CERTIFICATE_TYPE_UNSPECIFIED = 0;
  CERTIFICATE_TYPE_USER = 1;
  CERTIFICATE_TYPE_HOST = 2;
}

// Certificate Authority messages ---------------------------------------------
message CA {
  string id = 1;
  string workspace_id = 2;
  string name = 3;
  string description = 4;
  string certificate = 5;
  string public_key = 6;
  string serial_number = 7;
  string subject = 8;
  google.protobuf.Timestamp not_before = 9;
  google.protobuf.Timestamp not_after = 10;
  bool is_active = 11;
  bool is_default = 12;
  CertificateKeyType key_type = 13;
  int32 key_bits = 14;
  google.protobuf.Timestamp created_at = 15;
  google.protobuf.Timestamp updated_at = 16;
}

message CreateCARequest {
  string workspace_id = 1 [(buf.validate.field).string.uuid = true];
  string name = 2 [(buf.validate.field).string = {
    min_len: 1
    max_len: 255
  }];
  string description = 3 [(buf.validate.field).string.max_len = 1000];
  CertificateKeyType key_type = 4 [(buf.validate.field).enum = {
    defined_only: true
    not_in: [0]
  }];
  int32 key_bits = 5;
  int32 lifetime_months = 6 [(buf.validate.field).int32 = {
    gte: 1
    lte: 60 // Max 5 years
  }];
  bool is_default = 7;
}
message CreateCAResponse {
  CA ca = 1;
}

message GetCARequest {
  string id = 1 [(buf.validate.field).string.uuid = true];
}
message GetCAResponse {
  CA ca = 1;
}

message ListCAsRequest {
  string workspace_id = 1 [(buf.validate.field).string.uuid = true];
}
message ListCAsResponse {
  repeated CA cas = 1;
}

message UpdateCARequest {
  string id = 1 [(buf.validate.field).string.uuid = true];
  string description = 2 [(buf.validate.field).string.max_len = 1000];
  bool is_active = 3;
  bool is_default = 4;
}
message UpdateCAResponse {
  CA ca = 1;
}

message DeleteCARequest {
  string id = 1 [(buf.validate.field).string.uuid = true];
}
message DeleteCAResponse {}

message RolloverCARequest {
  string id = 1 [(buf.validate.field).string.uuid = true];
  CertificateKeyType key_type = 2;
  int32 key_bits = 3;
  int32 lifetime_months = 4;
  bool force = 5;
}
message RolloverCAResponse {
  CA ca = 1;
}

// Certificate Template messages ----------------------------------------------
message CertTemplate {
  string id = 1;
  string ca_id = 2;
  string name = 3;
  string description = 4;
  CertificateType type = 5;
  google.protobuf.Duration default_ttl = 6;
  google.protobuf.Duration max_ttl = 7;
  map<string, string> extensions = 8;
  map<string, string> critical_options = 9;
  repeated CertificateKeyType allowed_key_types = 10;
  bool is_active = 11;
  google.protobuf.Timestamp created_at = 12;
  google.protobuf.Timestamp updated_at = 13;
}

message CreateCertTemplateRequest {
  string ca_id = 1 [(buf.validate.field).string.uuid = true];
  string name = 2 [(buf.validate.field).string.min_len = 1];
  string workspace_id = 3 [(buf.validate.field).string.uuid = true];
  string description = 4 [(buf.validate.field).string.max_len = 1000];
  CertificateType type = 5 [(buf.validate.field).enum = {
    defined_only: true
    not_in: [0]
  }];
  google.protobuf.Duration default_ttl = 6 [(buf.validate.field).duration = {
    gte: {seconds: 60} /* Min 1 minute */
    lte: {seconds: 31536000} /* Max 1 year */
  }];
  google.protobuf.Duration max_ttl = 7 [(buf.validate.field).duration = {
    gte: {seconds: 60}
    lte: {seconds: 31536000}
  }];
  map<string, string> extensions = 8;
  map<string, string> critical_options = 9;
  repeated CertificateKeyType allowed_key_types = 10;
  google.protobuf.Struct custom_extensions = 11;
}
message CreateCertTemplateResponse {
  CertTemplate template = 1;
}

message GetCertTemplateRequest {
  string id = 1 [(buf.validate.field).string.uuid = true];
}
message GetCertTemplateResponse {
  CertTemplate template = 1;
}

message ListCertTemplatesRequest {
  string workspace_id = 1 [(buf.validate.field).string.uuid = true];
}
message ListCertTemplatesResponse {
  repeated CertTemplate templates = 1;
}

message UpdateCertTemplateRequest {
  string id = 1 [(buf.validate.field).string.uuid = true];
  string ca_id = 2 [(buf.validate.field).string.uuid = true];
  string description = 3 [(buf.validate.field).string.max_len = 1000];
  CertificateType type = 4 [(buf.validate.field).enum = {
    defined_only: true
    not_in: [0]
  }];
  google.protobuf.Duration default_ttl = 5;
  google.protobuf.Duration max_ttl = 6;
  map<string, string> extensions = 7;
  map<string, string> critical_options = 8;
  bool is_active = 9;
  repeated CertificateKeyType allowed_key_types = 10;
}
message UpdateCertTemplateResponse {
  CertTemplate template = 1;
}

message DeleteCertTemplateRequest {
  string id = 1 [(buf.validate.field).string.uuid = true];
}
message DeleteCertTemplateResponse {}

// Certificate messages -------------------------------------------------------
message Certificate {
  string ca_id = 1;
  string ca_name = 2;
  bytes ssh_certificate = 3 [(zyphor.v1.sensitive) = true];
  bytes ca_public_key = 4 [(zyphor.v1.sensitive) = true];
  google.protobuf.Timestamp expires_at = 5;
}
message SSHConfigOptions {
  string key_name = 1 [(buf.validate.field).string = {
    pattern: "^[a-zA-Z0-9_-]+$"
    max_len: 100
  }];
  string strict_host_key_checking = 2 [
    (buf.validate.field).string.in = "yes",
    (buf.validate.field).string.in = "no",
    (buf.validate.field).string.in = "accept-new"
  ];
  int32 keep_alive_interval = 3 [(buf.validate.field).int32 = {
    gte: 0
    lte: 3600
  }];
  int32 connect_timeout = 4 [(buf.validate.field).int32 = {
    gte: 1
    lte: 300
  }];
  bool add_hash_known_hosts = 5; // add HashKnownHosts yes
  string user_known_hosts_file = 6; // custom known_hosts file
  bool compression = 7; // enable compression
}

message SignPublicKeyUserRequest {
  string workspace_id = 1 [(buf.validate.field).string.uuid = true];
  string public_key = 2 [
    (buf.validate.field).string = {
      min_len: 1
      max_len: 10000
      pattern: "^ssh-(rsa|ed25519|ecdsa).*"
    },
    (zyphor.v1.sensitive) = true
  ];
  google.protobuf.Duration ttl = 3 [(buf.validate.field).duration = {
    gte: {seconds: 60}
    lte: {seconds: 31536000}
  }];
  SSHConfigOptions options = 4;
}
message SignPublicKeyUserResponse {
  repeated Certificate certificates = 1;
  string ssh_config = 2 [(zyphor.v1.sensitive) = true];
}

// Meant for agents
message SignPublicKeyHostRequest {
  repeated bytes public_keys = 1 [(zyphor.v1.sensitive) = true];
}
message SignPublicKeyHostResponse {
  repeated Certificate certificates = 1 [(zyphor.v1.sensitive) = true];
  bytes ca_public_key = 2 [(zyphor.v1.sensitive) = true];
}
