edition = "2023";

package zyphor.v1;

import "buf/validate/validate.proto";
import "google/api/annotations.proto";
import "google/protobuf/duration.proto";
import "google/protobuf/timestamp.proto";
import "zyphor/v1/target.proto";

service AgentService {
  rpc GetAgent(GetAgentRequest) returns (GetAgentResponse) {
    option idempotency_level = NO_SIDE_EFFECTS;
    option (google.api.http) = {get: "/v1/workspaces/{workspace_id}/agents/{id}"};
  }
  rpc UpdateAgent(UpdateAgentRequest) returns (UpdateAgentResponse) {
    option (google.api.http) = {patch: "/v1/workspaces/{workspace_id}/agents/{id}"};
  }
  rpc DeleteAgent(DeleteAgentRequest) returns (DeleteAgentResponse) {
    option (google.api.http) = {delete: "/v1/workspaces/{workspace_id}/agents/{id}"};
  }
  rpc ListAgents(ListAgentsRequest) returns (ListAgentsResponse) {
    option idempotency_level = NO_SIDE_EFFECTS;
    option (google.api.http) = {get: "/v1/workspaces/{workspace_id}/agents"};
  }
  rpc CreateBootstrapToken(CreateBootstrapTokenRequest) returns (CreateBootstrapTokenResponse) {
    option (google.api.http) = {post: "/v1/workspaces/{workspace_id}/agents/bootstrap-token"};
  }
  // Agent only endpoints
  rpc BootstrapAgent(BootstrapAgentRequest) returns (BootstrapAgentResponse);
  rpc AgentHeartbeat(AgentHeartbeatRequest) returns (AgentHeartbeatResponse);
}

enum AgentEventType {
  AGENT_EVENT_TYPE_UNSPECIFIED = 0;
  AGENT_EVENT_TYPE_STATUS = 1;
  AGENT_EVENT_TYPE_PRINCIPALS = 2;
  AGENT_EVENT_TYPE_CERTIFICATES = 3;
}
enum AgentStatus {
  AGENT_STATUS_UNSPECIFIED = 0;
  AGENT_STATUS_PENDING = 1;
  AGENT_STATUS_ACCEPTED = 2;
  AGENT_STATUS_REJECTED = 3;
}

message Agent {
  string id = 1;
  string workspace_id = 2;
  string target_id = 3;
  string name = 4;
  AgentStatus status = 5;
  AgentMetadata metadata = 6;
  google.protobuf.Timestamp updated_at = 7;
  google.protobuf.Timestamp created_at = 8;
}
message AgentMetadata {
  string version = 1;
}

// For nats
message AgentNotification {
  string agent_id = 1;
  AgentStatus status = 2;
  AgentEventType event_type = 3;
  google.protobuf.Timestamp timestamp = 4;
}

message GetAgentRequest {
  string id = 1 [(buf.validate.field).string.uuid = true];
  string workspace_id = 2 [(buf.validate.field).string.uuid = true];
}
message GetAgentResponse {
  Agent agent = 1;
  bool online = 2;
}

message UpdateAgentRequest {
  string id = 1 [(buf.validate.field).string.uuid = true];
  string workspace_id = 2 [(buf.validate.field).string.uuid = true];
  AgentStatus status = 3 [(buf.validate.field).enum = {
    defined_only: true
    not_in: [0] /* Prevent UNSPECIFIED */
  }];
}
message UpdateAgentResponse {}

message DeleteAgentRequest {
  string id = 1 [(buf.validate.field).string.uuid = true];
  string workspace_id = 2 [(buf.validate.field).string.uuid = true];
}
message DeleteAgentResponse {}

message ListAgentsRequest {
  string workspace_id = 1 [(buf.validate.field).string.uuid = true];
}
message ListAgentsResponse {
  repeated Agent agents = 1;
}

message CreateBootstrapTokenRequest {
  string workspace_id = 1 [(buf.validate.field).string.uuid = true];
  google.protobuf.Duration expiry = 2 [(buf.validate.field).duration = {
    gte: {seconds: 300} /* Min 5 minutes */
    lte: {seconds: 604800} /* Max 7 days */
  }];
}
message CreateBootstrapTokenResponse {
  string token = 1;
}

message BootstrapAgentRequest {
  string bootstrap_token = 1 [(buf.validate.field).string.min_len = 1];
  string hostname = 2 [(buf.validate.field).string = {
    min_len: 1
    max_len: 253
    pattern: "^[a-zA-Z0-9]([a-zA-Z0-9\\-]{0,61}[a-zA-Z0-9])?(\\.[a-zA-Z0-9]([a-zA-Z0-9\\-]{0,61}[a-zA-Z0-9])?)*$"
  }];
  AgentMetadata metadata = 3;
}
message BootstrapAgentResponse {
  Agent agent = 1;
  string token = 2;
}

message AgentHeartbeatRequest {
  string root_ca_id = 1 [(buf.validate.field).string.uuid = true];
  repeated string users = 2;
  AgentMetadata agent_metadata = 3;
  TargetMetadata target_metadata = 4;
}
message AgentHeartbeatResponse {}
