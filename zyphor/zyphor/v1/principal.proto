edition = "2023";

package zyphor.v1;

import "buf/validate/validate.proto";
import "google/api/annotations.proto";
import "google/protobuf/timestamp.proto";
import "zyphor/v1/options.proto";

service PrincipalService {
  rpc CreatePrincipal(CreatePrincipalRequest) returns (CreatePrincipalResponse) {
    option (google.api.http) = {
      post: "/v1/principal"
      body: "*"
    };
  }
  rpc ListPrincipals(ListPrincipalsRequest) returns (ListPrincipalsResponse) {
    option idempotency_level = NO_SIDE_EFFECTS;
    option (google.api.http) = {get: "/v1/principals/{workspace_id}"};
  }
  rpc DeletePrincipal(DeletePrincipalRequest) returns (DeletePrincipalResponse) {
    option (google.api.http) = {delete: "/v1/principal/{target_id}/{username}"};
  }
  rpc AddSubjectsToPrincipal(AddSubjectsToPrincipalRequest) returns (AddSubjectsToPrincipalResponse) {
    option (google.api.http) = {
      post: "/v1/principal/add"
      body: "*"
    };
  }
  rpc RemoveSubjectsFromPrincipal(RemoveSubjectsFromPrincipalRequest) returns (RemoveSubjectsFromPrincipalResponse) {
    option (google.api.http) = {
      post: "/v1/principal/remove"
      body: "*"
    };
  }
  rpc RevokeAllAccess(RevokeAllAccessRequest) returns (RevokeAllAccessResponse) {
    option (google.api.http) = {
      post: "/v1/principal/revoke"
      body: "*"
    };
  }
  rpc GetAgentPrincipals(GetAgentPrincipalsRequest) returns (GetAgentPrincipalsResponse);
}

enum PrincipalType {
  PRINCIPAL_TYPE_UNSPECIFIED = 0;
  PRINCIPAL_TYPE_USER = 1;
  PRINCIPAL_TYPE_TEAM = 2;
  PRINCIPAL_TYPE_SERVICE_ACCOUNT = 3;
}

message Principal {
  string id = 1;
  string target_id = 2;
  string username = 3 [(zyphor.v1.sensitive) = true];
  repeated string user_ids = 4;
  repeated string team_ids = 5;
  repeated string service_account_ids = 6;
  google.protobuf.Timestamp created_at = 7;
}

message CreatePrincipalRequest {
  string target_id = 1 [(buf.validate.field).string.uuid = true];
  string username = 2 [
    (buf.validate.field).string = {
      min_len: 1
      max_len: 32
      pattern: "^[a-z_][a-z0-9-_]*\\$?$" // Valid Unix username
    },
    (zyphor.v1.sensitive) = true
  ];
}
message CreatePrincipalResponse {
  Principal principal = 1;
}

message DeletePrincipalRequest {
  string target_id = 1 [(buf.validate.field).string.uuid = true];
  string username = 2 [
    (buf.validate.field).string.min_len = 1,
    (zyphor.v1.sensitive) = true
  ];
}
message DeletePrincipalResponse {}

message ListPrincipalsRequest {
  string workspace_id = 1 [(buf.validate.field).string.uuid = true];
}
message ListPrincipalsResponse {
  repeated Principal principals = 1;
}

message AddSubjectsToPrincipalRequest {
  string id = 1 [(buf.validate.field).string.uuid = true];
  repeated string subject_ids = 2 [(buf.validate.field).repeated = {
    min_items: 1
    max_items: 50
    items: {
      string: {uuid: true}
    }
  }];
  PrincipalType type = 3 [(buf.validate.field).enum = {
    defined_only: true
    not_in: [0]
  }];
}
message AddSubjectsToPrincipalResponse {}

message RemoveSubjectsFromPrincipalRequest {
  string id = 1 [(buf.validate.field).string.uuid = true];
  repeated string subject_ids = 2 [(buf.validate.field).repeated = {
    min_items: 1
    max_items: 50
    items: {
      string: {uuid: true}
    }
  }];
  PrincipalType type = 3 [(buf.validate.field).enum = {
    defined_only: true
    not_in: [0]
  }];
}
message RemoveSubjectsFromPrincipalResponse {}

message RevokeAllAccessRequest {
  string subject_id = 1 [(buf.validate.field).string.uuid = true];
  string workspace_id = 2 [(buf.validate.field).string.uuid = true];
  PrincipalType type = 3 [(buf.validate.field).enum = {
    defined_only: true
    not_in: [0]
  }];
}
message RevokeAllAccessResponse {}

// For agents
message PrincipalUsers {
  string username = 1 [(zyphor.v1.sensitive) = true];
  repeated string ids = 2;
}
message GetAgentPrincipalsRequest {}
message GetAgentPrincipalsResponse {
  repeated PrincipalUsers principals = 1;
}
