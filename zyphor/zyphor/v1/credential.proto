edition = "2023";

package zyphor.v1;

import "buf/validate/validate.proto";
import "google/api/annotations.proto";
import "google/protobuf/timestamp.proto";
import "zyphor/v1/options.proto";

service CredentialService {
  // Passwords
  rpc ChangePassword(ChangePasswordRequest) returns (ChangePasswordResponse) {
    option (google.api.http) = {
      patch: "/v1/password"
      body: "*"
    };
  }
  rpc DeletePassword(DeletePasswordRequest) returns (DeletePasswordResponse) {
    option (google.api.http) = {delete: "/v1/password"};
  }
  // Passkeys
  rpc ListPasskeys(ListPasskeysRequest) returns (ListPasskeysResponse) {
    option (google.api.http) = {get: "/v1/passkeys"};
  }
  rpc UpdatePasskey(UpdatePasskeyRequest) returns (UpdatePasskeyResponse) {
    option (google.api.http) = {
      patch: "/v1/passkeys/{id}"
      body: "*"
    };
  }
  rpc DeletePasskey(DeletePasskeyRequest) returns (DeletePasskeyResponse) {
    option (google.api.http) = {delete: "/v1/passkeys/{id}"};
  }
  // Backup codes
  rpc CreateBackupCodes(CreateBackupCodesRequest) returns (CreateBackupCodesResponse) {
    option (google.api.http) = {post: "/v1/backup-codes"};
  }
  rpc UseBackupCode(UseBackupCodeRequest) returns (UseBackupCodeResponse) {
    option (google.api.http) = {
      post: "/v1/backup-codes"
      body: "*"
    };
  }
  rpc ListBackupCodes(ListBackupCodesRequest) returns (ListBackupCodesResponse) {
    option (google.api.http) = {get: "/v1/backup-codes"};
  }
  rpc DeleteBackupCodes(DeleteBackupCodesRequest) returns (DeleteBackupCodesResponse) {
    option (google.api.http) = {delete: "/v1/backup-codes"};
  }
}

// Password messages ----------------------------------------------------------
message ChangePasswordRequest {
  string current_password = 1 [
    (buf.validate.field).string.min_len = 1,
    (zyphor.v1.sensitive) = true
  ];
  string new_password = 2 [
    (buf.validate.field).string.min_len = 8,
    (zyphor.v1.sensitive) = true
  ];
}
message ChangePasswordResponse {}

message DeletePasswordRequest {
  string current_password = 1 [
    (buf.validate.field).string.min_len = 1,
    (zyphor.v1.sensitive) = true
  ];
}
message DeletePasswordResponse {}

// Passkey messages -----------------------------------------------------------
message Passkey {
  string id = 1;
  string name = 2;
  google.protobuf.Timestamp created_at = 3;
  google.protobuf.Timestamp last_used_at = 4;
}

message UpdatePasskeyRequest {
  string id = 1 [(buf.validate.field).string.min_len = 1];
  string name = 2 [(buf.validate.field).string = {
    min_len: 1
    max_len: 100
  }];
}
message UpdatePasskeyResponse {
  Passkey passkey = 1;
}

message ListPasskeysRequest {}
message ListPasskeysResponse {
  repeated Passkey passkeys = 1;
}

message DeletePasskeyRequest {
  string id = 1 [(buf.validate.field).string.min_len = 1];
}
message DeletePasskeyResponse {}

// Backup code messages -------------------------------------------------------
message BackupCode {
  string id = 1;
  string code = 2 [(zyphor.v1.sensitive) = true];
  google.protobuf.Timestamp used_at = 3;
  google.protobuf.Timestamp created_at = 4;
}

message CreateBackupCodesRequest {}
message CreateBackupCodesResponse {
  repeated BackupCode codes = 1;
}

message UseBackupCodeRequest {
  string email = 1 [
    (buf.validate.field).string.email = true,
    (zyphor.v1.sensitive) = true
  ];
  string code = 2 [
    (buf.validate.field).string.min_len = 1,
    (zyphor.v1.sensitive) = true
  ];
}
message UseBackupCodeResponse {}

message ListBackupCodesRequest {}
message ListBackupCodesResponse {
  repeated BackupCode codes = 1;
}

message DeleteBackupCodesRequest {}
message DeleteBackupCodesResponse {}
